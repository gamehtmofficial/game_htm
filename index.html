<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAME_HTM - Ultimate Gaming Portal</title>
    <style>
        :root {
            --primary: #0ff0fc;
            --secondary: #ff00ff;
            --dark-bg: #0a0a1a;
            --darker-bg: #050510;
            --card-bg: rgba(20, 20, 40, 0.7);
            --glass: rgba(255, 255, 255, 0.05);
            --text: #e0e0ff;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            transition: all 0.5s ease;
        }
        
        .light-theme {
            --dark-bg: #f0f0ff;
            --darker-bg: #d0d0f0;
            --card-bg: rgba(255, 255, 255, 0.7);
            --glass: rgba(0, 0, 0, 0.05);
            --text: #202040;
        }
        
        .fade-in {
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }
        
        .header-buttons {
            display: flex;
            gap: 15px;
        }
        
        button {
            padding: 8px 16px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .theme-btn {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: var(--darker-bg);
            font-weight: 600;
        }
        
        .admin-btn {
            background: linear-gradient(90deg, #ff00ff, #ff5500);
            color: white;
            font-weight: 600;
        }
        
        .delete-btn {
            background: linear-gradient(90deg, #ff0000, #ff5555);
            color: white;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .game-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding: 20px 0;
        }
        
        .game-card {
            background: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .game-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3), 0 0 15px rgba(0, 255, 255, 0.2);
        }
        
        .game-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .game-info {
            padding: 15px;
        }
        
        .game-info h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .game-info p {
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .game-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .play-btn {
            display: block;
            width: 100%;
            padding: 10px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: var(--darker-bg);
            border: none;
            border-radius: 0 0 15px 15px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .play-btn:hover {
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }
        
        .modal, .admin-panel, .profile-panel, .game-player, .game-info-modal, .delete-confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content, .panel-content, .player-content, .game-info-content, .delete-confirm-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            position: relative;
        }
        
        .player-content, .game-info-content {
            max-width: 900px;
            padding: 20px;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        h2 {
            margin-bottom: 20px;
            color: var(--primary);
            text-align: center;
            font-size: 1.8rem;
        }
        
        input, textarea, select {
            width: 100%;
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
            color: var(--text);
            font-size: 1rem;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }
        
        .thumbnail-preview, .media-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .media-preview img, .media-preview video {
            width: 80px;
            height: 80px;
            object-fit: cover;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .media-preview img:hover, .media-preview video:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .game-frame {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 10px;
            background: #000;
        }
        
        .game-player h3, .game-info-content h3 {
            color: var(--primary);
            margin: 15px 0;
            text-align: center;
        }
        
        .game-player p, .game-info-content p {
            margin-bottom: 15px;
            opacity: 0.8;
        }
        
        .game-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .stars {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }
        
        .star {
            color: gold;
            font-size: 1.2rem;
        }
        
        .empty-star {
            color: #555;
            font-size: 1.2rem;
        }
        
        .file-input-label {
            display: block;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .file-input-label:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .file-input {
            display: none;
        }
        
        .login-success {
            color: #0ff0fc !important;
        }
        
        .admin-only {
            position: relative;
        }
        
        .admin-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: var(--darker-bg);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text);
            opacity: 0.7;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .zip-info {
            background: rgba(0, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid var(--primary);
        }
        
        .html-info {
            background: rgba(255, 215, 0, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid gold;
        }
        
        .game-info-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .game-info-header {
            display: flex;
            gap: 20px;
        }
        
        .game-info-image {
            flex: 0 0 200px;
        }
        
        .game-info-image img {
            width: 100%;
            border-radius: 10px;
        }
        
        .game-info-details {
            flex: 1;
        }
        
        .game-info-details h2 {
            text-align: left;
            margin-bottom: 10px;
        }
        
        .game-info-stats {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        
        .game-info-stat {
            text-align: center;
        }
        
        .game-info-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .game-info-stat-label {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .game-info-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .play-game-btn {
            flex: 1;
            padding: 12px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: var(--darker-bg);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .play-game-btn:hover {
            background: linear-gradient(90deg, var(--secondary), var(--primary));
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .game-info-description {
            line-height: 1.6;
        }
        
        .game-info-screenshots {
            margin-top: 20px;
        }
        
        .screenshots-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }
        
        .screenshot {
            width: 150px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .screenshot:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .zip-upload-section, .html-upload-section {
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .zip-upload-section h4, .html-upload-section h4 {
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        .zip-instructions, .html-instructions {
            font-size: 0.9rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }
        
        .zip-file-list, .html-file-preview {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }
        
        .zip-file-item, .html-file-item {
            padding: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .zip-file-item:last-child, .html-file-item:last-child {
            border-bottom: none;
        }
        
        .main-entry-point {
            background: rgba(0, 255, 255, 0.1);
            padding: 5px;
            border-radius: 3px;
            margin-left: 5px;
        }
        
        .zip-processing, .html-processing {
            display: none;
            text-align: center;
            padding: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .upload-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .upload-option-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-option-btn.active {
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid var(--primary);
        }
        
        .delete-game-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .game-card:hover .delete-game-btn {
            opacity: 1;
        }
        
        .delete-confirm-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .confirm-delete-btn {
            background: linear-gradient(90deg, #ff0000, #ff5555);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .cancel-delete-btn {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .fullscreen-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 2000;
            display: none;
        }
        
        .fullscreen-game-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .fullscreen-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 2001;
        }
        
        .exit-fullscreen-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .game-list {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            .header {
                padding: 10px 15px;
                flex-direction: column;
                gap: 10px;
            }
            
            .header-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .modal-content, .panel-content {
                width: 95%;
                padding: 20px;
            }
            
            .game-info-header {
                flex-direction: column;
            }
            
            .game-info-image {
                flex: 0 0 auto;
                text-align: center;
            }
            
            .game-info-image img {
                max-width: 200px;
            }
            
            .upload-options {
                flex-direction: column;
            }
            
            .delete-game-btn {
                opacity: 1;
                font-size: 0.7rem;
                padding: 3px 6px;
            }
        }
    </style>
</head>
<body class="fade-in">
    <div class="header">
        <div class="logo">GAME_HTM</div>
        <div class="header-buttons">
            <button id="adminBtn" class="admin-btn" style="display: none;">Admin</button>
            <button id="loginBtnMain">Login</button>
            <button id="themeBtn" class="theme-btn">Theme</button>
        </div>
    </div>

    <div class="container">
        <div class="game-list" id="gameList">
            <div class="empty-state">
                <h3>Welcome to GAME_HTM</h3>
                <p>Login to start playing amazing games</p>
                <p>New users can register with any username</p>
            </div>
        </div>
    </div>

    <!-- Login/Register Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <button class="close-btn" id="closeLoginBtn">&times;</button>
            <h2>Welcome to GAME_HTM</h2>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button id="loginBtn">Login</button>
            <button id="registerBtn">Register</button>
            <div id="loginMsg" style="margin-top:10px;text-align:center;"></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="panel-content">
            <button class="close-btn" id="closeAdminBtn">&times;</button>
            <h2>Admin Tools</h2>
            <div class="user-info">
                <p>Add new games to the portal</p>
            </div>
            <input type="text" id="gameTitle" placeholder="Game Title">
            <textarea id="gameDesc" placeholder="Game Description" rows="3"></textarea>
            <input type="text" id="gameCategory" placeholder="Category (comma separated)">
            <select id="gameRating">
                <option value="">Select Rating</option>
                <option value="1">1 Star</option>
                <option value="2">2 Stars</option>
                <option value="3">3 Stars</option>
                <option value="4">4 Stars</option>
                <option value="5">5 Stars</option>
            </select>
            
            <label for="gameThumbnail" class="file-input-label">Choose Thumbnail Image (Optional)</label>
            <input type="file" id="gameThumbnail" class="file-input" accept="image/*">
            
            <!-- Upload Options -->
            <div class="upload-options">
                <div class="upload-option-btn active" id="zipOptionBtn">ZIP File</div>
                <div class="upload-option-btn" id="htmlOptionBtn">Single HTML File</div>
            </div>
            
            <!-- ZIP File Upload Section -->
            <div class="zip-upload-section" id="zipUploadSection">
                <h4>ZIP File Upload</h4>
                <div class="zip-instructions">
                    <p>Upload a ZIP file containing your game files. The main entry point should be an HTML file named "index.html" or "game.html".</p>
                </div>
                <label for="gameZip" class="file-input-label">Choose ZIP File</label>
                <input type="file" id="gameZip" class="file-input" accept=".zip">
                <div class="zip-processing" id="zipProcessing">
                    <p>Processing ZIP file...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="zipProgress"></div>
                    </div>
                </div>
                <div class="zip-file-list" id="zipFileList"></div>
            </div>
            
            <!-- Single HTML File Upload Section -->
            <div class="html-upload-section" id="htmlUploadSection" style="display: none;">
                <h4>Single HTML File Upload</h4>
                <div class="html-instructions">
                    <p>Upload a single HTML file for your game. This should be the main game file that will be loaded when players start the game.</p>
                </div>
                <label for="gameHtml" class="file-input-label">Choose HTML File</label>
                <input type="file" id="gameHtml" class="file-input" accept=".html">
                <div class="html-file-preview" id="htmlFilePreview"></div>
            </div>
            
            <button id="addGameBtn">Publish Game</button>
            
            <div class="thumbnail-preview" id="thumbnailPreview"></div>
            <div id="adminMsg" style="margin-top:10px;text-align:center;"></div>
        </div>
    </div>

    <!-- Profile Panel -->
    <div class="profile-panel" id="profilePanel">
        <div class="panel-content">
            <button class="close-btn" id="closeProfileBtn">&times;</button>
            <h2>User Profile</h2>
            <div id="profileUsername" class="user-info"></div>
            <h3>Favorites:</h3>
            <ul id="profileFavorites"></ul>
            <h3>History:</h3>
            <ul id="profileHistory"></ul>
            <button id="logoutBtn">Logout</button>
        </div>
    </div>

    <!-- Game Info Modal (Like Crazy Games) -->
    <div class="game-info-modal" id="gameInfoModal">
        <div class="game-info-content">
            <button class="close-btn" id="closeGameInfoBtn">&times;</button>
            <div class="game-info-container">
                <div class="game-info-header">
                    <div class="game-info-image">
                        <img id="gameInfoImage" src="" alt="Game Image">
                    </div>
                    <div class="game-info-details">
                        <h2 id="gameInfoTitle">Game Title</h2>
                        <div class="stars" id="gameInfoStars"></div>
                        <p id="gameInfoCategory" class="game-info-category"></p>
                        <div class="game-info-stats">
                            <div class="game-info-stat">
                                <div class="game-info-stat-value" id="gameInfoPlays">0</div>
                                <div class="game-info-stat-label">Plays</div>
                            </div>
                            <div class="game-info-stat">
                                <div class="game-info-stat-value" id="gameInfoLikes">0</div>
                                <div class="game-info-stat-label">Likes</div>
                            </div>
                            <div class="game-info-stat">
                                <div class="game-info-stat-value" id="gameInfoRating">0</div>
                                <div class="game-info-stat-label">Rating</div>
                            </div>
                        </div>
                        <div class="game-info-actions">
                            <button class="play-game-btn" id="playGameFromInfoBtn">Play Game</button>
                            <button id="likeGameBtn">Like ♡</button>
                        </div>
                    </div>
                </div>
                <div class="game-info-description">
                    <h3>About this game</h3>
                    <p id="gameInfoDescription">Game description goes here...</p>
                </div>
                <div class="game-info-screenshots">
                    <h3>Screenshots</h3>
                    <div class="screenshots-container" id="gameInfoScreenshots"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Player -->
    <div class="game-player" id="gamePlayer">
        <div class="player-content">
            <button class="close-btn" id="closeGameBtn">&times;</button>
            <h3 id="gamePlayerTitle"></h3>
            <p id="gamePlayerDesc"></p>
            <div class="stars" id="gamePlayerStars"></div>
            <div class="game-frame-container">
                <iframe class="game-frame" id="gameFrame" src="about:blank"></iframe>
            </div>
            <div class="game-controls">
                <button id="addToFavoritesBtn">Add to Favorites</button>
                <button id="fullscreenBtn">Fullscreen</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="delete-confirm-modal" id="deleteConfirmModal">
        <div class="delete-confirm-content">
            <button class="close-btn" id="closeDeleteConfirmBtn">&times;</button>
            <h2>Delete Game</h2>
            <p>Are you sure you want to delete this game? This action cannot be undone.</p>
            <div class="delete-confirm-actions">
                <button class="confirm-delete-btn" id="confirmDeleteBtn">Delete Game</button>
                <button class="cancel-delete-btn" id="cancelDeleteBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Fullscreen Container -->
    <div class="fullscreen-container" id="fullscreenContainer">
        <div class="fullscreen-controls">
            <button class="exit-fullscreen-btn" id="exitFullscreenBtn">Exit Fullscreen</button>
        </div>
        <iframe class="fullscreen-game-frame" id="fullscreenGameFrame" src="about:blank"></iframe>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, 
            orderBy, query, serverTimestamp, setDoc, increment, deleteDoc 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { 
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
            signOut, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAQeAd0PZHuiYrWTVTl2dJ9N5FqRPgHzP0",
            authDomain: "game-htm.firebaseapp.com",
            projectId: "game-htm",
            storageBucket: "game-htm.firebasestorage.app",
            messagingSenderId: "209461056965",
            appId: "1:209461056965:web:f632d68cce68f2e92327ac"
        };

        // Initialize Firebase (Only Firestore & Auth - NO STORAGE)
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global variables
        let currentUser = null;
        let currentUserData = null;
        let games = [];
        let currentGameIndex = -1;
        let zipFiles = {};
        let htmlFile = null;
        let currentUploadType = 'zip'; // 'zip' or 'html'
        let gameToDelete = null;

        // DOM Elements
        const loginModal = document.getElementById('loginModal');
        const adminPanel = document.getElementById('adminPanel');
        const profilePanel = document.getElementById('profilePanel');
        const gamePlayer = document.getElementById('gamePlayer');
        const gameInfoModal = document.getElementById('gameInfoModal');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const fullscreenContainer = document.getElementById('fullscreenContainer');
        const gameList = document.getElementById('gameList');

        // ============================================================================
        // AUTHENTICATION FUNCTIONS
        // ============================================================================
        document.getElementById('loginBtnMain').onclick = () => {
            if (currentUser) {
                profilePanel.style.display = 'flex';
                renderProfile();
            } else {
                loginModal.style.display = 'flex';
            }
        };

        document.getElementById('loginBtn').onclick = async () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginMsg = document.getElementById('loginMsg');
            
            if (!username || !password) {
                loginMsg.innerHTML = '<span style="color: #ff5555">Please enter both username and password</span>';
                return;
            }
            
            try {
                let email;
                let isAdmin = false;
                
                // Check for admin credentials
                if (username === 'KABIRPROKK' && password === 'ISHANNOOB') {
                    email = 'kabirprokk@gamehtm.com';
                    isAdmin = true;
                } else {
                    email = username + '@gamehtm.com';
                }
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                
                // Create or update user document in Firestore
                await setDoc(doc(db, 'users', currentUser.uid), {
                    username: username,
                    email: email,
                    isAdmin: isAdmin,
                    favorites: [],
                    history: [],
                    likedGames: [],
                    createdAt: serverTimestamp()
                }, { merge: true });
                
                // Get user data
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                currentUserData = userDoc.data();
                
                loginMsg.innerHTML = '<span style="color: #0ff0fc">Login successful! Welcome ' + username + '</span>';
                
                setTimeout(() => {
                    loginModal.style.display = 'none';
                    loginMsg.innerHTML = '';
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    updateUI();
                    loadGames();
                }, 1500);
                
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    loginMsg.innerHTML = '<span style="color: #ff5555">ID NOT FOUND - Please check your username</span>';
                } else if (error.code === 'auth/wrong-password') {
                    loginMsg.innerHTML = '<span style="color: #ff5555">Wrong password - Please check your password</span>';
                } else if (error.code === 'auth/invalid-email') {
                    loginMsg.innerHTML = '<span style="color: #ff5555">Invalid username format</span>';
                } else {
                    loginMsg.innerHTML = '<span style="color: #ff5555">Login failed - Please try again</span>';
                }
            }
        };

        document.getElementById('registerBtn').onclick = async () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginMsg = document.getElementById('loginMsg');
            
            if (!username || !password) {
                loginMsg.innerHTML = '<span style="color: #ff5555">Please enter both username and password</span>';
                return;
            }
            
            if (username === 'KABIRPROKK') {
                loginMsg.innerHTML = '<span style="color: #ff5555">This username is reserved</span>';
                return;
            }
            
            try {
                const email = username + '@gamehtm.com';
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
                
                await setDoc(doc(db, 'users', currentUser.uid), {
                    username: username,
                    email: email,
                    isAdmin: false,
                    favorites: [],
                    history: [],
                    likedGames: [],
                    createdAt: serverTimestamp()
                });
                
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                currentUserData = userDoc.data();
                
                loginMsg.innerHTML = '<span style="color: #0ff0fc">Registration successful! Welcome ' + username + '</span>';
                
                setTimeout(() => {
                    loginModal.style.display = 'none';
                    loginMsg.innerHTML = '';
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    updateUI();
                    loadGames();
                }, 1500);
                
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    loginMsg.innerHTML = '<span style="color: #ff5555">Username already exists</span>';
                } else if (error.code === 'auth/weak-password') {
                    loginMsg.innerHTML = '<span style="color: #ff5555">Password is too weak</span>';
                } else {
                    loginMsg.innerHTML = '<span style="color: #ff5555">Registration failed</span>';
                }
            }
        };

        // ============================================================================
        // UPLOAD TYPE SELECTION
        // ============================================================================
        document.getElementById('zipOptionBtn').onclick = () => {
            currentUploadType = 'zip';
            document.getElementById('zipOptionBtn').classList.add('active');
            document.getElementById('htmlOptionBtn').classList.remove('active');
            document.getElementById('zipUploadSection').style.display = 'block';
            document.getElementById('htmlUploadSection').style.display = 'none';
        };

        document.getElementById('htmlOptionBtn').onclick = () => {
            currentUploadType = 'html';
            document.getElementById('htmlOptionBtn').classList.add('active');
            document.getElementById('zipOptionBtn').classList.remove('active');
            document.getElementById('htmlUploadSection').style.display = 'block';
            document.getElementById('zipUploadSection').style.display = 'none';
        };

        // ============================================================================
        // GAME MANAGEMENT FUNCTIONS
        // ============================================================================
        async function loadGames() {
            try {
                const q = query(collection(db, 'games'), orderBy('createdAt', 'desc'));
                const snapshot = await getDocs(q);
                games = [];
                snapshot.forEach(doc => {
                    games.push({ id: doc.id, ...doc.data() });
                });
                renderGames();
            } catch (error) {
                console.error('Error loading games:', error);
            }
        }

        async function saveGame(gameData) {
            try {
                const docRef = await addDoc(collection(db, 'games'), {
                    ...gameData,
                    plays: 0,
                    likes: 0,
                    createdAt: serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error('Error saving game:', error);
                throw error;
            }
        }

        async function deleteGame(gameId) {
            try {
                await deleteDoc(doc(db, 'games', gameId));
                return true;
            } catch (error) {
                console.error('Error deleting game:', error);
                throw error;
            }
        }

        async function updateGameStats(gameId, field) {
            try {
                const gameRef = doc(db, 'games', gameId);
                await updateDoc(gameRef, {
                    [field]: increment(1)
                });
            } catch (error) {
                console.error('Error updating game stats:', error);
            }
        }

        // ============================================================================
        // ZIP FILE HANDLING
        // ============================================================================
        document.getElementById('gameZip').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const zipProcessing = document.getElementById('zipProcessing');
            const zipFileList = document.getElementById('zipFileList');
            const zipProgress = document.getElementById('zipProgress');
            
            zipProcessing.style.display = 'block';
            zipFileList.innerHTML = '';
            zipProgress.style.width = '0%';
            
            // Reset zipFiles
            zipFiles = {};
            
            // Use JSZip library for ZIP processing
            if (typeof JSZip === 'undefined') {
                // Load JSZip dynamically
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                script.onload = () => processZipFile(file, zipProcessing, zipFileList, zipProgress);
                document.head.appendChild(script);
            } else {
                processZipFile(file, zipProcessing, zipFileList, zipProgress);
            }
        });

        function processZipFile(file, zipProcessing, zipFileList, zipProgress) {
            const zip = new JSZip();
            
            zip.loadAsync(file, { 
                onUpdate: (metadata) => {
                    const progress = (metadata.percent / 100) * 100;
                    zipProgress.style.width = `${progress}%`;
                }
            })
            .then(function(zip) {
                zipProcessing.style.display = 'none';
                zipFileList.innerHTML = '';
                
                let mainEntryPoint = '';
                const files = [];
                
                // Process each file in the ZIP
                Object.keys(zip.files).forEach(function(filename) {
                    const zipFile = zip.files[filename];
                    
                    // Skip directories
                    if (zipFile.dir) return;
                    
                    files.push(filename);
                    
                    // Check if this is a potential main entry point
                    if (filename.toLowerCase() === 'index.html' || filename.toLowerCase() === 'game.html') {
                        mainEntryPoint = filename;
                    }
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'zip-file-item';
                    fileItem.textContent = filename;
                    
                    if (filename === mainEntryPoint) {
                        const badge = document.createElement('span');
                        badge.className = 'main-entry-point';
                        badge.textContent = 'Main';
                        fileItem.appendChild(badge);
                    }
                    
                    zipFileList.appendChild(fileItem);
                });
                
                // Store the ZIP data for later use
                zipFiles.currentZip = zip;
                zipFiles.mainEntryPoint = mainEntryPoint;
                zipFiles.files = files;
                
                console.log('ZIP processing completed:', {
                    mainEntryPoint: mainEntryPoint,
                    files: files,
                    zipFiles: zipFiles
                });
                
                // If no main entry point was found, use the first HTML file
                if (!mainEntryPoint) {
                    const htmlFiles = files.filter(f => f.toLowerCase().endsWith('.html'));
                    if (htmlFiles.length > 0) {
                        mainEntryPoint = htmlFiles[0];
                        zipFiles.mainEntryPoint = mainEntryPoint;
                        
                        // Update the UI to show the main entry point
                        const fileItems = zipFileList.querySelectorAll('.zip-file-item');
                        fileItems.forEach(item => {
                            if (item.textContent.includes(mainEntryPoint)) {
                                const badge = document.createElement('span');
                                badge.className = 'main-entry-point';
                                badge.textContent = 'Main';
                                item.appendChild(badge);
                            }
                        });
                        
                        console.log('Found HTML file as main entry:', mainEntryPoint);
                    } else {
                        console.log('No HTML files found in ZIP');
                        alert('No HTML files found in the ZIP. Please make sure your ZIP contains an index.html or game.html file.');
                    }
                }
                
            })
            .catch(function(error) {
                zipProcessing.style.display = 'none';
                console.error('Error processing ZIP file:', error);
                alert('Error processing ZIP file. Please make sure it is a valid ZIP archive.');
            });
        }

        // ============================================================================
        // HTML FILE HANDLING
        // ============================================================================
        document.getElementById('gameHtml').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Check if file is HTML
            if (!file.name.toLowerCase().endsWith('.html')) {
                alert('Please select an HTML file');
                this.value = '';
                return;
            }
            
            htmlFile = file;
            
            const htmlFilePreview = document.getElementById('htmlFilePreview');
            htmlFilePreview.innerHTML = '';
            
            const fileItem = document.createElement('div');
            fileItem.className = 'html-file-item';
            fileItem.textContent = file.name;
            
            const badge = document.createElement('span');
            badge.className = 'main-entry-point';
            badge.textContent = 'Main';
            fileItem.appendChild(badge);
            
            htmlFilePreview.appendChild(fileItem);
        });

        // ============================================================================
        // THUMBNAIL HANDLING
        // ============================================================================
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function convertHtmlToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // ============================================================================
        // UI FUNCTIONS
        // ============================================================================
        function renderGames() {
            gameList.innerHTML = '';
            
            if (games.length === 0) {
                gameList.innerHTML = `
                    <div class="empty-state">
                        <h3>Welcome to GAME_HTM</h3>
                        <p>No games available yet</p>
                        <p>Administrators can add games to get started</p>
                    </div>
                `;
                return;
            }
            
            games.forEach((game, idx) => {
                const card = document.createElement('div');
                card.className = 'game-card fade-in';
                
                let starsHtml = '';
                for (let i = 1; i <= 5; i++) {
                    if (i <= game.rating) {
                        starsHtml += '<span class="star">★</span>';
                    } else {
                        starsHtml += '<span class="empty-star">★</span>';
                    }
                }
                
                card.innerHTML = `
                    ${currentUserData && currentUserData.isAdmin ? 
                        `<button class="delete-game-btn" data-gameid="${game.id}">Delete</button>` : 
                        ''}
                    <img src="${game.thumbnail}" alt="${game.title}">
                    <div class="game-info">
                        <h3>${game.title}</h3>
                        <p>${game.description}</p>
                        <div class="game-meta">
                            <span>${Array.isArray(game.category) ? game.category.join(', ') : game.category}</span>
                            <div class="stars">${starsHtml}</div>
                        </div>
                    </div>
                    <button class="play-btn" data-index="${idx}">PLAY NOW</button>
                `;
                gameList.appendChild(card);
            });
            
            document.querySelectorAll('.play-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    showGameInfo(index);
                });
            });
            
            // Add delete button event listeners for admins
            if (currentUserData && currentUserData.isAdmin) {
                document.querySelectorAll('.delete-game-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const gameId = this.getAttribute('data-gameid');
                        showDeleteConfirm(gameId);
                    });
                });
            }
        }

        function showDeleteConfirm(gameId) {
            gameToDelete = gameId;
            deleteConfirmModal.style.display = 'flex';
        }

        function showGameInfo(index) {
            if (!currentUser) {
                loginModal.style.display = 'flex';
                return;
            }
            
            currentGameIndex = index;
            const game = games[index];
            
            // Update game info modal
            document.getElementById('gameInfoTitle').innerText = game.title;
            document.getElementById('gameInfoImage').src = game.thumbnail;
            document.getElementById('gameInfoDescription').innerText = game.description;
            document.getElementById('gameInfoCategory').innerText = Array.isArray(game.category) ? game.category.join(', ') : game.category;
            document.getElementById('gameInfoPlays').innerText = game.plays || 0;
            document.getElementById('gameInfoLikes').innerText = game.likes || 0;
            document.getElementById('gameInfoRating').innerText = game.rating || 0;
            
            // Update stars
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= game.rating) {
                    starsHtml += '<span class="star">★</span>';
                } else {
                    starsHtml += '<span class="empty-star">★</span>';
                }
            }
            document.getElementById('gameInfoStars').innerHTML = starsHtml;
            
            // Update like button
            const likeBtn = document.getElementById('likeGameBtn');
            if (currentUserData && currentUserData.likedGames && currentUserData.likedGames.includes(game.id)) {
                likeBtn.innerHTML = 'Liked ♥';
                likeBtn.style.color = '#ff00ff';
            } else {
                likeBtn.innerHTML = 'Like ♡';
                likeBtn.style.color = '';
            }
            
            // Update screenshots (if available)
            const screenshotsContainer = document.getElementById('gameInfoScreenshots');
            screenshotsContainer.innerHTML = '';
            
            // Add thumbnail as first screenshot
            const thumbnailScreenshot = document.createElement('img');
            thumbnailScreenshot.className = 'screenshot';
            thumbnailScreenshot.src = game.thumbnail;
            thumbnailScreenshot.alt = 'Game Thumbnail';
            screenshotsContainer.appendChild(thumbnailScreenshot);
            
            // Add additional screenshots if available
            if (game.screenshots && Array.isArray(game.screenshots)) {
                game.screenshots.forEach(screenshot => {
                    const screenshotImg = document.createElement('img');
                    screenshotImg.className = 'screenshot';
                    screenshotImg.src = screenshot;
                    screenshotImg.alt = 'Game Screenshot';
                    screenshotsContainer.appendChild(screenshotImg);
                });
            }
            
            // Show the game info modal
            gameInfoModal.style.display = 'flex';
        }

        function playGame(index) {
            if (!currentUser) {
                loginModal.style.display = 'flex';
                return;
            }
            
            currentGameIndex = index;
            const game = games[index];
            
            // Update game stats
            updateGameStats(game.id, 'plays');
            updateUserHistory(game.title);
            
            document.getElementById('gamePlayerTitle').innerText = game.title;
            document.getElementById('gamePlayerDesc').innerText = game.description;
            
            let starsHtml = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= game.rating) {
                    starsHtml += '<span class="star">★</span>';
                } else {
                    starsHtml += '<span class="empty-star">★</span>';
                }
            }
            document.getElementById('gamePlayerStars').innerHTML = starsHtml;
            
            // Load the game from ZIP data or HTML file
            if (game.zipData) {
                loadZipGame(game);
            } else if (game.htmlData) {
                loadHtmlGame(game);
            } else {
                // Fallback - show a message about the game
                loadFallbackGame(game);
            }
            
            gamePlayer.style.display = 'flex';
            gameInfoModal.style.display = 'none';
        }

        function loadZipGame(game) {
            const gameFrame = document.getElementById('gameFrame');
            const fullscreenFrame = document.getElementById('fullscreenGameFrame');
            
            // For ZIP-based games, we need to handle the file upload differently
            // Since we can't store the actual ZIP content in Firestore, we'll create a placeholder
            if (game.zipData && game.mainEntryPoint) {
                const gameContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${game.title}</title>
                        <style>
                            body {
                                margin: 0;
                                padding: 0;
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                font-family: Arial, sans-serif;
                                display: flex;
                                justify-content: center;
                                align-items: center;
                                height: 100vh;
                                color: white;
                            }
                            .game-container {
                                text-align: center;
                                background: rgba(0, 0, 0, 0.7);
                                padding: 40px;
                                border-radius: 15px;
                                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                            }
                            h1 {
                                margin-bottom: 20px;
                                font-size: 2.5rem;
                            }
                            p {
                                margin: 10px 0;
                                font-size: 1.1rem;
                            }
                            .game-info {
                                background: rgba(255, 255, 255, 0.1);
                                padding: 15px;
                                border-radius: 10px;
                                margin: 20px 0;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="game-container">
                            <h1>🎮 ${game.title}</h1>
                            <div class="game-info">
                                <p><strong>Game Type:</strong> ZIP File Game</p>
                                <p><strong>Main File:</strong> ${game.mainEntryPoint}</p>
                                <p><strong>Status:</strong> Game files loaded successfully</p>
                            </div>
                            <p>This game was uploaded as a ZIP file containing:</p>
                            <p>📁 Multiple game assets and files</p>
                            <p>🚀 Ready to play in full implementation</p>
                            <p style="margin-top: 30px; font-style: italic;">
                                In a full implementation, the actual game files would be extracted and served here.
                            </p>
                        </div>
                    </body>
                    </html>
                `;
                gameFrame.srcdoc = gameContent;
                fullscreenFrame.srcdoc = gameContent;
            } else {
                loadFallbackGame(game);
            }
        }

        function loadHtmlGame(game) {
            const gameFrame = document.getElementById('gameFrame');
            const fullscreenFrame = document.getElementById('fullscreenGameFrame');
            
            if (game.htmlData) {
                try {
                    // Convert base64 back to HTML content
                    const base64Data = game.htmlData.split(',')[1];
                    const htmlContent = atob(base64Data);
                    gameFrame.srcdoc = htmlContent;
                    fullscreenFrame.srcdoc = htmlContent;
                } catch (error) {
                    console.error('Error loading HTML game:', error);
                    loadFallbackGame(game, 'Error loading game content');
                }
            } else {
                loadFallbackGame(game);
            }
        }

        function loadFallbackGame(game, errorMessage = 'Game content not available') {
            const gameFrame = document.getElementById('gameFrame');
            const fullscreenFrame = document.getElementById('fullscreenGameFrame');
            
            const fallbackContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${game.title}</title>
                    <style>
                        body {
                            margin: 0;
                            padding: 0;
                            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                            font-family: Arial, sans-serif;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            height: 100vh;
                            color: white;
                        }
                        .error-container {
                            text-align: center;
                            background: rgba(0, 0, 0, 0.7);
                            padding: 40px;
                            border-radius: 15px;
                            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                        }
                        h1 {
                            margin-bottom: 20px;
                            font-size: 2.5rem;
                        }
                        p {
                            margin: 10px 0;
                            font-size: 1.1rem;
                        }
                        .error-message {
                            background: rgba(255, 255, 255, 0.1);
                            padding: 15px;
                            border-radius: 10px;
                            margin: 20px 0;
                            border-left: 4px solid #ff9ff3;
                        }
                    </style>
                </head>
                <body>
                    <div class="error-container">
                        <h1>⚠️ ${game.title}</h1>
                        <div class="error-message">
                            <p><strong>Status:</strong> ${errorMessage}</p>
                        </div>
                        <p>Game Type: ${game.zipData ? 'ZIP File' : game.htmlData ? 'HTML File' : 'Unknown'}</p>
                        <p>Main Entry: ${game.mainEntryPoint || 'Not specified'}</p>
                        <p style="margin-top: 30px; font-style: italic;">
                            This is a demo implementation. In production, the actual game would load here.
                        </p>
                    </div>
                </body>
                </html>
            `;
            
            gameFrame.srcdoc = fallbackContent;
            fullscreenFrame.srcdoc = fallbackContent;
        }

        async function updateUserHistory(gameTitle) {
            if (!currentUser) return;
            
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const userData = userDoc.data();
                let history = userData.history || [];
                
                if (!history.includes(gameTitle)) {
                    history.push(gameTitle);
                    await updateDoc(doc(db, 'users', currentUser.uid), {
                        history: history
                    });
                    currentUserData.history = history;
                }
            } catch (error) {
                console.error('Error updating history:', error);
            }
        }

        // ============================================================================
        // FULLSCREEN FUNCTIONALITY
        // ============================================================================
        document.getElementById('fullscreenBtn').onclick = () => {
            // Use a separate iframe for fullscreen to prevent performance issues
            const gameFrame = document.getElementById('gameFrame');
            const fullscreenFrame = document.getElementById('fullscreenGameFrame');
            
            // Copy the current game content to the fullscreen iframe
            fullscreenFrame.srcdoc = gameFrame.srcdoc;
            
            // Show the fullscreen container
            fullscreenContainer.style.display = 'block';
            
            // Optimize for performance
            document.body.style.overflow = 'hidden';
            
            // Hide the original game player
            gamePlayer.style.display = 'none';
        };

        document.getElementById('exitFullscreenBtn').onclick = () => {
            // Exit fullscreen
            fullscreenContainer.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Show the original game player
            gamePlayer.style.display = 'flex';
        };

        // Handle ESC key to exit fullscreen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && fullscreenContainer.style.display === 'block') {
                document.getElementById('exitFullscreenBtn').click();
            }
        });

        // ============================================================================
        // EVENT LISTENERS
        // ============================================================================
        document.getElementById('closeLoginBtn').onclick = () => { 
            loginModal.style.display = 'none'; 
            document.getElementById('loginMsg').innerHTML = '';
        };

        document.getElementById('adminBtn').onclick = async () => { 
            if (!currentUser) {
                loginModal.style.display = 'flex';
                return;
            }
            
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists() && userDoc.data().isAdmin) {
                    adminPanel.style.display = 'flex';
                } else {
                    alert('Only administrators can access this feature');
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
                alert('Error checking permissions');
            }
        };

        document.getElementById('closeAdminBtn').onclick = () => { 
            adminPanel.style.display = 'none'; 
            resetAdminForm();
        };

        document.getElementById('closeGameBtn').onclick = () => { 
            gamePlayer.style.display = 'none'; 
            document.getElementById('gameFrame').src = 'about:blank';
        };

        document.getElementById('closeGameInfoBtn').onclick = () => { 
            gameInfoModal.style.display = 'none'; 
        };

        document.getElementById('closeDeleteConfirmBtn').onclick = () => { 
            deleteConfirmModal.style.display = 'none'; 
            gameToDelete = null;
        };

        document.getElementById('cancelDeleteBtn').onclick = () => { 
            deleteConfirmModal.style.display = 'none'; 
            gameToDelete = null;
        };

        document.getElementById('confirmDeleteBtn').onclick = async () => {
            if (!gameToDelete) return;
            
            try {
                await deleteGame(gameToDelete);
                deleteConfirmModal.style.display = 'none';
                gameToDelete = null;
                loadGames();
                alert('Game deleted successfully!');
            } catch (error) {
                console.error('Error deleting game:', error);
                alert('Error deleting game. Please try again.');
            }
        };

        document.getElementById('playGameFromInfoBtn').onclick = () => {
            playGame(currentGameIndex);
        };

        document.getElementById('likeGameBtn').onclick = async () => {
            if (!currentUser) return;
            
            const game = games[currentGameIndex];
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const userData = userDoc.data();
                let likedGames = userData.likedGames || [];
                
                if (!likedGames.includes(game.id)) {
                    // Like the game
                    likedGames.push(game.id);
                    await updateDoc(doc(db, 'users', currentUser.uid), {
                        likedGames: likedGames
                    });
                    await updateGameStats(game.id, 'likes');
                    currentUserData.likedGames = likedGames;
                    
                    // Update UI
                    document.getElementById('likeGameBtn').innerHTML = 'Liked ♥';
                    document.getElementById('likeGameBtn').style.color = '#ff00ff';
                    document.getElementById('gameInfoLikes').innerText = (game.likes || 0) + 1;
                    
                    // Update the game data locally
                    games[currentGameIndex].likes = (game.likes || 0) + 1;
                } else {
                    // Unlike the game
                    const index = likedGames.indexOf(game.id);
                    if (index > -1) {
                        likedGames.splice(index, 1);
                    }
                    await updateDoc(doc(db, 'users', currentUser.uid), {
                        likedGames: likedGames
                    });
                    // Note: We're not decrementing likes count in this simple implementation
                    currentUserData.likedGames = likedGames;
                    
                    // Update UI
                    document.getElementById('likeGameBtn').innerHTML = 'Like ♡';
                    document.getElementById('likeGameBtn').style.color = '';
                }
            } catch (error) {
                console.error('Error updating likes:', error);
            }
        };

        document.getElementById('addToFavoritesBtn').onclick = async () => {
            if (!currentUser) return;
            
            const game = games[currentGameIndex];
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                const userData = userDoc.data();
                let favorites = userData.favorites || [];
                
                if (!favorites.includes(game.title)) {
                    favorites.push(game.title);
                    await updateDoc(doc(db, 'users', currentUser.uid), {
                        favorites: favorites
                    });
                    currentUserData.favorites = favorites;
                    renderProfile();
                    alert('Added to favorites!');
                } else {
                    alert('Already in favorites!');
                }
            } catch (error) {
                console.error('Error updating favorites:', error);
            }
        };

        // Handle thumbnail preview
        document.getElementById('gameThumbnail').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('thumbnailPreview');
                    preview.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '200px';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });

        // Game publishing with ZIP or HTML file
        document.getElementById('addGameBtn').onclick = async () => {
            if (!currentUser) return;
            
            let isAdmin = false;
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                isAdmin = userDoc.exists() && userDoc.data().isAdmin;
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
            
            if (!isAdmin) {
                alert('Only administrators can publish games');
                return;
            }
            
            const title = document.getElementById('gameTitle').value;
            const desc = document.getElementById('gameDesc').value;
            const category = document.getElementById('gameCategory').value.split(',').map(c => c.trim());
            const rating = parseInt(document.getElementById('gameRating').value) || 0;
            const thumbFile = document.getElementById('gameThumbnail').files[0];
            
            if (!title || !desc) { 
                document.getElementById('adminMsg').innerHTML = '<span style="color: #ff5555">Title and description are required</span>';
                return; 
            }
            
            // Check if either ZIP or HTML file is provided
            if (currentUploadType === 'zip') {
                const zipFileInput = document.getElementById('gameZip');
                if (!zipFileInput.files[0]) {
                    document.getElementById('adminMsg').innerHTML = '<span style="color: #ff5555">Please select a ZIP file</span>';
                    return;
                }
                
                console.log('ZIP Files object:', zipFiles);
                
                // Check if ZIP processing is complete
                if (!zipFiles.currentZip) {
                    document.getElementById('adminMsg').innerHTML = '<span style="color: #ff5555">ZIP file is still processing. Please wait...</span>';
                    return;
                }
                
                // Check if we found an HTML entry point
                if (!zipFiles.mainEntryPoint) {
                    document.getElementById('adminMsg').innerHTML = '<span style="color: #ff5555">No HTML entry point found in ZIP file. Please make sure your ZIP contains an index.html or game.html file.</span>';
                    return;
                }
            }
            
            if (currentUploadType === 'html' && !htmlFile) {
                document.getElementById('adminMsg').innerHTML = '<span style="color: #ff5555">An HTML file is required</span>';
                return;
            }
            
            try {
                let thumbnailURL = '';
                
                // Convert thumbnail to base64 if provided
                if (thumbFile) {
                    thumbnailURL = await convertImageToBase64(thumbFile);
                } else {
                    // Use default placeholder from free image service
                    thumbnailURL = 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80';
                }
                
                // Prepare game data
                const gameData = {
                    title,
                    description: desc,
                    category,
                    rating,
                    thumbnail: thumbnailURL,
                    publishedBy: currentUser.uid,
                    publishedAt: new Date().toISOString()
                };
                
                // Add ZIP or HTML data
                if (currentUploadType === 'zip') {
                    gameData.zipData = true;
                    gameData.mainEntryPoint = zipFiles.mainEntryPoint;
                    gameData.fileCount = zipFiles.files ? zipFiles.files.length : 0;
                    
                    // Store a sample of the file list (first 10 files)
                    if (zipFiles.files && zipFiles.files.length > 0) {
                        gameData.fileList = zipFiles.files.slice(0, 10);
                    }
                    
                    console.log('Publishing ZIP game:', gameData);
                    
                } else if (currentUploadType === 'html') {
                    gameData.htmlData = await convertHtmlToBase64(htmlFile);
                    gameData.fileType = 'single-html';
                    console.log('Publishing HTML game:', gameData);
                }
                
                // Save game to Firestore
                await saveGame(gameData);
                
                document.getElementById('adminMsg').innerHTML = '<span style="color: #0ff0fc">Game published successfully!</span>';
                
                setTimeout(() => {
                    adminPanel.style.display = 'none';
                    resetAdminForm();
                    loadGames();
                }, 1500);
                
            } catch (error) {
                console.error('Error publishing game:', error);
                document.getElementById('adminMsg').innerHTML = '<span style="color: #ff5555">Error publishing game: ' + error.message + '</span>';
            }
        };

        function resetAdminForm() {
            document.getElementById('gameTitle').value = '';
            document.getElementById('gameDesc').value = '';
            document.getElementById('gameCategory').value = '';
            document.getElementById('gameRating').value = '';
            document.getElementById('gameThumbnail').value = '';
            document.getElementById('gameZip').value = '';
            document.getElementById('gameHtml').value = '';
            document.getElementById('thumbnailPreview').innerHTML = '';
            document.getElementById('zipFileList').innerHTML = '';
            document.getElementById('htmlFilePreview').innerHTML = '';
            document.getElementById('adminMsg').innerHTML = '';
            zipFiles = {};
            htmlFile = null;
            currentUploadType = 'zip';
            document.getElementById('zipOptionBtn').classList.add('active');
            document.getElementById('htmlOptionBtn').classList.remove('active');
            document.getElementById('zipUploadSection').style.display = 'block';
            document.getElementById('htmlUploadSection').style.display = 'none';
        }

        // Profile functions
        document.getElementById('loginBtnMain').onclick = () => { 
            if (!currentUser) {
                loginModal.style.display = 'flex';
                return;
            }
            profilePanel.style.display = 'flex'; 
            renderProfile(); 
        };

        document.getElementById('closeProfileBtn').onclick = () => { profilePanel.style.display = 'none'; };

        document.getElementById('logoutBtn').onclick = () => {
            signOut(auth).then(() => {
                currentUser = null;
                currentUserData = null;
                loginModal.style.display = 'none';
                profilePanel.style.display = 'none';
                updateUI();
                games = [];
                renderGames();
            });
        };

        function renderProfile() {
            if (!currentUser || !currentUserData) return;
            
            document.getElementById('profileUsername').innerHTML = `
                <p><strong>Username:</strong> ${currentUserData.username}</p>
                <p><strong>Email:</strong> ${currentUserData.email}</p>
                <p><strong>Status:</strong> ${currentUserData.isAdmin ? 'Administrator' : 'Regular User'}</p>
            `;
            
            const favList = document.getElementById('profileFavorites');
            favList.innerHTML = '';
            if (currentUserData.favorites && currentUserData.favorites.length > 0) {
                currentUserData.favorites.forEach(f => { 
                    const li = document.createElement('li'); 
                    li.innerText = f; 
                    favList.appendChild(li); 
                });
            } else {
                favList.innerHTML = '<li>No favorites yet</li>';
            }
            
            const histList = document.getElementById('profileHistory');
            histList.innerHTML = '';
            if (currentUserData.history && currentUserData.history.length > 0) {
                currentUserData.history.forEach(h => { 
                    const li = document.createElement('li'); 
                    li.innerText = h; 
                    histList.appendChild(li); 
                });
            } else {
                histList.innerHTML = '<li>No game history</li>';
            }
        }

        function updateUI() {
            if (currentUser) {
                document.getElementById('loginBtnMain').textContent = 'Profile';
                if (currentUserData && currentUserData.isAdmin) {
                    document.getElementById('adminBtn').style.display = 'block';
                } else {
                    document.getElementById('adminBtn').style.display = 'none';
                }
            } else {
                document.getElementById('loginBtnMain').textContent = 'Login';
                document.getElementById('adminBtn').style.display = 'none';
            }
        }

        // Theme toggle
        let dark = true;
        document.getElementById('themeBtn').onclick = () => {
            dark = !dark;
            document.body.classList.toggle('light-theme', !dark);
        };

        // Initialize
        loadGames();

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists()) {
                        currentUserData = userDoc.data();
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
                updateUI();
                loadGames();
            } else {
                currentUser = null;
                currentUserData = null;
                updateUI();
            }
        });

    </script>
</body>
</html>
